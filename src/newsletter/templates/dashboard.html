<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Knowledge in Chain</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23000'/%3E%3Ctext x='16' y='23' font-family='monospace' font-size='20' font-weight='bold' fill='%23f59e0b' text-anchor='middle'%3EK%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', 'Share Tech Mono', 'Courier New', monospace;
    background-color: #000000;
    background-image: radial-gradient(circle, #1a1a1a 1px, transparent 1px);
    background-size: 24px 24px;
    color: #d4d4d4;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* Login */
  .login-wrap {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .login-box {
    background: #0a0a0a;
    border: 1px solid #292929;
    border-radius: 8px;
    padding: 48px 40px;
    max-width: 400px;
    width: 100%;
    text-align: center;
  }

  .login-box h1 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
    color: #fafafa;
  }

  .login-box .subtitle {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: #f59e0b;
    margin-bottom: 32px;
    text-transform: uppercase;
    letter-spacing: 4px;
  }

  .login-box input[type="password"] {
    width: 100%;
    padding: 14px 18px;
    border: 1px solid #292929;
    border-radius: 6px;
    background: #000000;
    color: #fafafa;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    outline: none;
    margin-bottom: 16px;
    transition: border-color 0.2s;
  }

  .login-box input[type="password"]:focus {
    border-color: #f59e0b;
  }

  .login-box button {
    width: 100%;
    padding: 14px;
    background: #f59e0b;
    color: #000000;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .login-box button:hover {
    background: #d97706;
    transform: translateY(-1px);
  }

  .login-error {
    color: #f87171;
    font-size: 13px;
    margin-bottom: 16px;
  }

  /* Dashboard layout */
  .dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .dash-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .dash-header h1 {
    font-size: 18px;
    font-weight: 700;
    color: #fafafa;
  }

  .dash-header h1 span {
    color: #f59e0b;
  }

  .dash-header .actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-decoration: none;
  }

  .btn-primary {
    background: #f59e0b;
    color: #000000;
  }

  .btn-primary:hover {
    background: #d97706;
    transform: translateY(-1px);
  }

  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .btn-outline {
    background: transparent;
    color: #737373;
    border: 1px solid #292929;
  }

  .btn-outline:hover {
    border-color: #404040;
    color: #d4d4d4;
  }

  .refresh-note {
    font-size: 11px;
    color: #404040;
  }

  /* KPI cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .kpi-card {
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    padding: 24px;
    transition: border-color 0.2s;
  }

  .kpi-card:hover {
    border-color: #292929;
  }

  .kpi-card .label {
    font-size: 11px;
    color: #525252;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
  }

  .kpi-card .value {
    font-size: 28px;
    font-weight: 800;
    color: #f59e0b;
  }

  .kpi-card .sub {
    font-size: 12px;
    color: #525252;
    margin-top: 4px;
  }

  /* Tables */
  .section {
    margin-bottom: 28px;
  }

  .section h2 {
    font-size: 13px;
    font-weight: 700;
    color: #737373;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .table-wrap {
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    text-align: left;
    padding: 10px 16px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #404040;
    border-bottom: 1px solid #1a1a1a;
    background: rgba(0, 0, 0, 0.3);
  }

  td {
    padding: 9px 16px;
    font-size: 13px;
    border-bottom: 1px solid #0f0f0f;
    color: #a3a3a3;
  }

  tr:last-child td {
    border-bottom: none;
  }

  tr:hover td {
    background: rgba(245, 158, 11, 0.02);
  }

  .status-completed { color: #34d399; }
  .status-running { color: #f59e0b; }
  .status-failed { color: #f87171; }

  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 768px) {
    .two-col { grid-template-columns: 1fr; }
  }

  .note-box {
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-left: 3px solid #f59e0b;
    border-radius: 0 8px 8px 0;
    padding: 16px 20px;
    font-size: 12px;
    color: #525252;
    margin-bottom: 32px;
  }

  .note-box strong {
    color: #f59e0b;
  }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #0a0a0a;
    border: 1px solid #f59e0b;
    border-radius: 6px;
    padding: 12px 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: #f59e0b;
    display: none;
    z-index: 100;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  }

  .toast.show { display: block; }

  /* LinkedIn modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal {
    background: #0a0a0a;
    border: 1px solid #292929;
    border-radius: 8px;
    padding: 32px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal h3 {
    font-size: 14px;
    font-weight: 700;
    color: #60a5fa;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 16px;
  }

  .modal pre {
    background: #000000;
    border: 1px solid #1a1a1a;
    border-radius: 6px;
    padding: 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: #d4d4d4;
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.6;
    margin-bottom: 16px;
    max-height: 50vh;
    overflow-y: auto;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .btn-blue {
    background: #60a5fa;
    color: #000000;
  }

  .btn-blue:hover {
    background: #3b82f6;
    transform: translateY(-1px);
  }
</style>
</head>
<body>

{% if not authenticated %}
<!-- Login form -->
<div class="login-wrap">
  <div class="login-box">
    <h1>Dashboard</h1>
    <p class="subtitle">Knowledge in Chain</p>
    {% if error %}
    <p class="login-error">{{ error }}</p>
    {% endif %}
    <form method="POST" action="/dashboard/login">
      <input type="password" name="password" placeholder="password" required autofocus>
      <button type="submit">Log in</button>
    </form>
  </div>
</div>

{% else %}
<!-- Dashboard -->
<div class="dashboard">
  <div class="dash-header">
    <h1><span>//</span> Knowledge in Chain</h1>
    <div class="actions">
      <span class="refresh-note" id="lastRefresh"></span>
      <button class="btn btn-outline" onclick="loadAll()">Refresh</button>
      <select id="pipelineMode" style="padding:8px 12px;border:1px solid #292929;border-radius:6px;background:#0a0a0a;color:#d4d4d4;font-family:'JetBrains Mono',monospace;font-size:12px;">
        <option value="dry-run">Dry Run</option>
        <option value="preview">Preview</option>
        <option value="send-pending">Send Pending</option>
      </select>
      <button class="btn btn-primary" id="triggerBtn" onclick="triggerPipeline()">Run</button>
      <a href="/" class="btn btn-outline">Landing</a>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card" onclick="openSubscriberCharts()" style="cursor:pointer;" title="Click to view growth charts">
      <div class="label">Subscribers</div>
      <div class="value" id="kpiSubscribers">-</div>
      <div class="sub" id="kpiSubNew"></div>
    </div>
    <div class="kpi-card">
      <div class="label">Articles</div>
      <div class="value" id="kpiArticles">-</div>
      <div class="sub" id="kpiArticlesSub"></div>
    </div>
    <div class="kpi-card">
      <div class="label">Monthly Cost</div>
      <div class="value" id="kpiMonthlyCost">-</div>
      <div class="sub" id="kpiTotalCost"></div>
    </div>
    <div class="kpi-card">
      <div class="label">Emails Sent</div>
      <div class="value" id="kpiEmails">-</div>
      <div class="sub" id="kpiEmailsSub"></div>
    </div>
  </div>

  <!-- Note about untracked costs -->
  <div class="note-box">
    <strong>Note:</strong> Resend (email) and Railway (hosting) costs are not tracked.
    Resend free tier: 3,000 emails/month. Railway billed separately.
  </div>

  <!-- Two column tables -->
  <div class="two-col">
    <div class="section">
      <h2>By Source</h2>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Source</th><th>Count</th></tr></thead>
          <tbody id="tableBySource"><tr><td colspan="2">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <h2>By Category</h2>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Category</th><th>Count</th></tr></thead>
          <tbody id="tableByCategory"><tr><td colspan="2">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Cost per run -->
  <div class="section">
    <h2>API Cost / Run</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Run ID</th><th>Input Tok</th><th>Output Tok</th><th>Cost</th></tr></thead>
        <tbody id="tableCostByRun"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Pending newsletters -->
  <div class="section">
    <h2>Pending Newsletters</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Subject</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="tablePending"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Edition History -->
  <div class="section">
    <h2>Edition History</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Date</th><th>Subject</th><th>Signal</th><th>Translate</th><th>Actions</th></tr></thead>
        <tbody id="tableHistory"><tr><td colspan="6">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Subscribers list -->
  <div class="section">
    <h2>Subscribers</h2>
    <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
      <table>
        <thead><tr><th>Email</th><th>Subscribed</th><th>Status</th></tr></thead>
        <tbody id="tableSubscribers"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Pipeline runs -->
  <div class="section">
    <h2>Pipeline Runs</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Status</th><th>Started</th><th>Duration</th>
            <th>Collected</th><th>Curated</th><th>Emails</th><th>Error</th>
          </tr>
        </thead>
        <tbody id="tablePipelineRuns"><tr><td colspan="8">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Recent emails -->
  <div class="section">
    <h2>Recent Emails</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Recipient</th><th>Status</th><th>Date</th><th>Error</th></tr></thead>
        <tbody id="tableEmails"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="section" id="failedEmailsSection" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2>Failed Emails (Last 7 Days)</h2>
      <button class="btn btn-primary" onclick="retryFailedEmails()" id="retryBtn" disabled>
        Retry Selected (<span id="selectedCount">0</span>)
      </button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px;">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th>Recipient</th>
            <th>Failed At</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="tableFailedEmails"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="linkedinModal" onclick="closeLinkedIn(event)">
  <div class="modal">
    <h3>LinkedIn Post</h3>
    <pre id="linkedinText"></pre>
    <div class="modal-actions">
      <button class="btn btn-blue" onclick="copyLinkedIn()">Copy</button>
      <button class="btn btn-outline" onclick="closeLinkedIn()">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="editModal" onclick="closeEdit(event)">
  <div class="modal">
    <h3>Edit Edition</h3>
    <input type="hidden" id="editId">
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:11px;color:#525252;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">Edition Number</label>
      <input type="number" id="editEdition" min="1" style="width:100%;padding:10px 14px;border:1px solid #292929;border-radius:6px;background:#000;color:#fafafa;font-family:'JetBrains Mono',monospace;font-size:14px;outline:none;">
    </div>
    <div style="margin-bottom:20px;">
      <label style="display:block;font-size:11px;color:#525252;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">Edition Date</label>
      <input type="text" id="editDate" placeholder="February 16, 2026" style="width:100%;padding:10px 14px;border:1px solid #292929;border-radius:6px;background:#000;color:#fafafa;font-family:'JetBrains Mono',monospace;font-size:14px;outline:none;">
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      <button class="btn btn-outline" onclick="closeEdit()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="subscriberModal" onclick="closeSubscriberModal(event)">
  <div class="modal" style="max-width:720px;">
    <h3 style="color:#f59e0b;">Subscriber Growth</h3>
    <div style="margin-bottom:24px;">
      <div style="font-size:11px;color:#525252;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;">Weekly (last 12 weeks)</div>
      <div id="chartWeekly" style="background:#000;border:1px solid #1a1a1a;border-radius:6px;padding:16px;min-height:180px;display:flex;align-items:center;justify-content:center;">
        <span style="color:#404040;font-size:13px;">Loading...</span>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#525252;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;">Monthly (last 12 months)</div>
      <div id="chartMonthly" style="background:#000;border:1px solid #1a1a1a;border-radius:6px;padding:16px;min-height:180px;display:flex;align-items:center;justify-content:center;">
        <span style="color:#404040;font-size:13px;">Loading...</span>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeSubscriberModal()">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  function $(id) { return document.getElementById(id); }

  function showToast(msg) {
    var t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 3000);
  }

  function fmt(n) {
    if (n === undefined || n === null) return '-';
    return n.toLocaleString();
  }

  function fmtUsd(n) {
    if (n === undefined || n === null) return '-';
    return '$' + n.toFixed(4);
  }

  function fmtDate(iso) {
    if (!iso) return '-';
    var d = new Date(iso);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  function fmtDuration(s) {
    if (s === null || s === undefined) return '-';
    if (s < 60) return s.toFixed(1) + 's';
    return (s / 60).toFixed(1) + 'm';
  }

  async function fetchJson(url) {
    var res = await fetch(url);
    if (!res.ok) return null;
    return res.json();
  }

  async function loadSubscribers() {
    var data = await fetchJson('/api/dashboard/subscribers');
    if (!data) return;
    $('kpiSubscribers').textContent = fmt(data.active);
    var parts = [];
    if (data.last_7_days) parts.push('+' + fmt(data.last_7_days) + ' this week');
    if (data.last_30_days) parts.push('+' + fmt(data.last_30_days) + ' this month');
    $('kpiSubNew').textContent = parts.join(' \u00b7 ') || 'No subscribers yet';
  }

  async function loadArticles() {
    var data = await fetchJson('/api/dashboard/articles');
    if (!data) return;
    $('kpiArticles').textContent = fmt(data.total);
    $('kpiArticlesSub').textContent = fmt(data.curated) + ' curated Â· ' + fmt(data.sent) + ' sent';

    var src = '';
    (data.by_source || []).forEach(function(r) {
      src += '<tr><td>' + esc(r.source) + '</td><td>' + fmt(r.count) + '</td></tr>';
    });
    $('tableBySource').innerHTML = src || '<tr><td colspan="2">No data</td></tr>';

    var cat = '';
    (data.by_category || []).forEach(function(r) {
      cat += '<tr><td>' + esc(r.category) + '</td><td>' + fmt(r.count) + '</td></tr>';
    });
    $('tableByCategory').innerHTML = cat || '<tr><td colspan="2">No data</td></tr>';
  }

  async function loadCosts() {
    var data = await fetchJson('/api/dashboard/api-costs');
    if (!data) return;
    $('kpiMonthlyCost').textContent = fmtUsd(data.monthly_cost_usd);
    $('kpiTotalCost').textContent = 'Total: ' + fmtUsd(data.total_cost_usd);

    var html = '';
    (data.by_run || []).forEach(function(r) {
      html += '<tr><td>' + esc(r.run_id) + '</td><td>' + fmt(r.input_tokens) + '</td><td>' + fmt(r.output_tokens) + '</td><td>' + fmtUsd(r.cost) + '</td></tr>';
    });
    $('tableCostByRun').innerHTML = html || '<tr><td colspan="4">No data</td></tr>';
  }

  async function loadEmails() {
    var data = await fetchJson('/api/dashboard/emails');
    if (!data) return;
    $('kpiEmails').textContent = fmt(data.total_sent);
    $('kpiEmailsSub').textContent = fmt(data.total_failed) + ' failed';

    var html = '';
    (data.recent || []).forEach(function(r) {
      html += '<tr><td>' + esc(r.recipient) + '</td><td>' + esc(r.status) + '</td><td>' + fmtDate(r.created_at) + '</td><td>' + esc(r.error || '') + '</td></tr>';
    });
    $('tableEmails').innerHTML = html || '<tr><td colspan="4">No data</td></tr>';

    // Also load failed emails
    loadFailedEmails();
  }

  async function loadFailedEmails() {
    var data = await fetchJson('/api/dashboard/emails/failed?days=7');
    if (!data) return;

    if (data.unique_recipients === 0) {
      $('failedEmailsSection').style.display = 'none';
      return;
    }

    $('failedEmailsSection').style.display = 'block';

    var html = '';
    (data.failed_emails || []).forEach(function(r) {
      html += '<tr>'
        + '<td><input type="checkbox" class="email-checkbox" value="' + esc(r.recipient) + '"></td>'
        + '<td>' + esc(r.recipient) + '</td>'
        + '<td>' + fmtDate(r.failed_at) + '</td>'
        + '<td style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + esc(r.error || '') + '">' + esc(r.error || '') + '</td>'
        + '</tr>';
    });
    $('tableFailedEmails').innerHTML = html || '<tr><td colspan="4">No failed emails</td></tr>';

    // Add event listeners to all checkboxes after they're inserted
    var checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(function(cb) {
      cb.addEventListener('change', window.updateSelectedCount);
    });

    window.updateSelectedCount();
  }

  window.toggleSelectAll = function() {
    var checkboxes = document.querySelectorAll('.email-checkbox');
    var selectAll = $('selectAll').checked;
    checkboxes.forEach(function(cb) {
      cb.checked = selectAll;
    });
    window.updateSelectedCount();
  };

  window.updateSelectedCount = function() {
    var checkboxes = document.querySelectorAll('.email-checkbox:checked');
    var count = checkboxes.length;
    $('selectedCount').textContent = count;
    $('retryBtn').disabled = count === 0;
  };

  window.retryFailedEmails = async function() {
    var checkboxes = document.querySelectorAll('.email-checkbox:checked');
    var recipients = Array.from(checkboxes).map(function(cb) { return cb.value; });

    if (recipients.length === 0) {
      alert('Please select at least one email to retry');
      return;
    }

    if (!confirm('Retry sending to ' + recipients.length + ' recipient(s)?')) {
      return;
    }

    $('retryBtn').disabled = true;
    $('retryBtn').textContent = 'Sending...';

    try {
      var res = await fetch('/api/dashboard/emails/retry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recipients: recipients })
      });
      var data = await res.json();

      if (data.ok) {
        alert(data.message);
        loadFailedEmails(); // Reload the list
      } else {
        alert('Error: ' + (data.message || 'Unknown error'));
        $('retryBtn').disabled = false;
        $('retryBtn').innerHTML = 'Retry Selected (<span id="selectedCount">' + recipients.length + '</span>)';
      }
    } catch (err) {
      alert('Network error: ' + err.message);
      $('retryBtn').disabled = false;
      $('retryBtn').innerHTML = 'Retry Selected (<span id="selectedCount">' + recipients.length + '</span>)';
    }
  }

  async function loadPending() {
    var data = await fetchJson('/api/dashboard/pending-newsletters');
    if (!data) return;
    var html = '';
    (data || []).forEach(function(r) {
      html += '<tr>'
        + '<td>' + esc(r.subject) + '</td>'
        + '<td>' + fmtDate(r.created_at) + '</td>'
        + '<td><a href="/newsletter/' + encodeURIComponent(r.id) + '" target="_blank" style="color:#f59e0b;text-decoration:none;">View</a>'
        + ' &middot; <a href="#" onclick="viewLinkedIn(\'' + esc(r.id) + '\');return false;" style="color:#60a5fa;text-decoration:none;">LinkedIn</a>'
        + ' &middot; <a href="#" onclick="editPending(\'' + esc(r.id) + '\');return false;" style="color:#34d399;text-decoration:none;">Edit</a>'
        + ' &middot; <a href="#" onclick="deletePending(\'' + esc(r.id) + '\');return false;" style="color:#f87171;text-decoration:none;">Delete</a></td>'
        + '</tr>';
    });
    $('tablePending').innerHTML = html || '<tr><td colspan="3">No pending newsletters</td></tr>';
  }

  async function loadPipelineRuns() {
    var data = await fetchJson('/api/dashboard/pipeline-runs');
    if (!data) return;
    var html = '';
    (data || []).forEach(function(r) {
      var cls = 'status-' + r.status;
      html += '<tr>'
        + '<td>' + esc(r.id) + '</td>'
        + '<td class="' + cls + '">' + esc(r.status) + '</td>'
        + '<td>' + fmtDate(r.started_at) + '</td>'
        + '<td>' + fmtDuration(r.duration_seconds) + '</td>'
        + '<td>' + fmt(r.articles_collected) + '</td>'
        + '<td>' + fmt(r.articles_curated) + '</td>'
        + '<td>' + fmt(r.emails_sent) + '/' + fmt(r.emails_failed) + '</td>'
        + '<td>' + esc(r.error_message || '') + '</td>'
        + '</tr>';
    });
    $('tablePipelineRuns').innerHTML = html || '<tr><td colspan="8">No data</td></tr>';
  }

  function esc(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  async function loadSubscriberList() {
    var data = await fetchJson('/api/dashboard/subscribers/list');
    if (!data) return;
    var html = '';
    (data || []).forEach(function(r) {
      var status = r.active ? '<span style="color:#34d399;">Active</span>' : '<span style="color:#f87171;">Inactive</span>';
      html += '<tr><td>' + esc(r.email) + '</td><td>' + fmtDate(r.subscribed_at) + '</td><td>' + status + '</td></tr>';
    });
    $('tableSubscribers').innerHTML = html || '<tr><td colspan="3">No subscribers</td></tr>';
  }

  async function loadHistory() {
    var data = await fetchJson('/api/dashboard/newsletter-history');
    if (!data) return;
    var html = '';
    (data || []).forEach(function(r, i) {
      html += '<tr>'
        + '<td>' + (i + 1) + '</td>'
        + '<td>' + esc(r.edition_date) + '</td>'
        + '<td>' + esc(r.subject_line || '') + '</td>'
        + '<td>' + esc(r.signal_topic || '') + '</td>'
        + '<td>' + esc(r.translate_concept || '') + '</td>'
        + '<td><a href="#" onclick="deleteHistory(' + r.id + ');return false;" style="color:#f87171;text-decoration:none;">Delete</a></td>'
        + '</tr>';
    });
    $('tableHistory').innerHTML = html || '<tr><td colspan="6">No history entries</td></tr>';
  }

  window.loadAll = function() {
    loadSubscribers();
    loadArticles();
    loadCosts();
    loadEmails();
    loadPending();
    loadPipelineRuns();
    loadHistory();
    loadSubscriberList();
    $('lastRefresh').textContent = new Date().toLocaleTimeString();
  };

  window.deletePending = async function(id) {
    if (!confirm('Delete this pending newsletter? This cannot be undone.')) return;
    try {
      var res = await fetch('/api/dashboard/pending-newsletters/' + encodeURIComponent(id), {method: 'DELETE'});
      var data = await res.json();
      if (res.ok) {
        showToast('Newsletter deleted');
        loadPending();
      } else {
        showToast(data.message || 'Failed to delete');
      }
    } catch(e) {
      showToast('Error deleting newsletter');
    }
  };

  window.editPending = function(id) {
    $('editId').value = id;
    $('editEdition').value = '';
    $('editDate').value = '';
    $('editModal').classList.add('show');
    $('editEdition').focus();
  };

  window.saveEdit = async function() {
    var id = $('editId').value;
    var num = parseInt($('editEdition').value, 10);
    var date = $('editDate').value.trim();
    if (!num || num < 1) { showToast('Enter a valid edition number'); return; }
    if (!date) { showToast('Enter an edition date'); return; }
    try {
      var res = await fetch('/api/dashboard/pending-newsletters/' + encodeURIComponent(id), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({edition_number: num, edition_date: date})
      });
      var data = await res.json();
      if (res.ok) {
        showToast(data.message || 'Updated');
        $('editModal').classList.remove('show');
        loadPending();
      } else {
        showToast(data.message || 'Failed to update');
      }
    } catch(e) {
      showToast('Error updating newsletter');
    }
  };

  window.closeEdit = function(e) {
    if (e && e.target !== $('editModal')) return;
    $('editModal').classList.remove('show');
  };

  window.deleteHistory = async function(id) {
    if (!confirm('Delete this history entry? This will affect edition numbering for future newsletters.')) return;
    try {
      var res = await fetch('/api/dashboard/newsletter-history/' + id, {method: 'DELETE'});
      var data = await res.json();
      if (res.ok) {
        showToast('History entry deleted');
        loadHistory();
      } else {
        showToast(data.message || 'Failed to delete');
      }
    } catch(e) {
      showToast('Error deleting history entry');
    }
  };

  window.triggerPipeline = async function() {
    var btn = $('triggerBtn');
    var mode = $('pipelineMode').value;
    btn.disabled = true;
    btn.textContent = 'Running...';
    try {
      var res = await fetch('/api/dashboard/trigger-pipeline', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: mode})
      });
      var data = await res.json();
      showToast(data.message || 'Pipeline triggered');
    } catch(e) {
      showToast('Error triggering pipeline');
    }
    btn.disabled = false;
    btn.textContent = 'Run';
    setTimeout(loadAll, 2000);
  };

  window.viewLinkedIn = async function(id) {
    try {
      var res = await fetch('/newsletter/' + encodeURIComponent(id) + '/linkedin');
      if (!res.ok) {
        showToast('No LinkedIn post found');
        return;
      }
      var data = await res.json();
      $('linkedinText').textContent = data.linkedin_post || 'No post available';
      $('linkedinModal').classList.add('show');
    } catch(e) {
      showToast('Error loading LinkedIn post');
    }
  };

  window.copyLinkedIn = async function() {
    var text = $('linkedinText').textContent;
    try {
      await navigator.clipboard.writeText(text);
      showToast('Copied to clipboard');
    } catch(e) {
      showToast('Failed to copy');
    }
  };

  window.closeLinkedIn = function(e) {
    if (e && e.target !== $('linkedinModal')) return;
    $('linkedinModal').classList.remove('show');
  };

  // --- Subscriber growth charts ---
  function renderChart(containerId, data, label) {
    var container = $(containerId);
    if (!data || data.length === 0) {
      container.innerHTML = '<span style="color:#404040;font-size:13px;">No data yet</span>';
      return;
    }

    var maxVal = Math.max.apply(null, data.map(function(d) { return d.total; }));
    if (maxVal === 0) maxVal = 1;

    var w = 640, h = 160;
    var padL = 8, padR = 8, padT = 24, padB = 32;
    var chartW = w - padL - padR;
    var chartH = h - padT - padB;
    var n = data.length;
    var step = n > 1 ? chartW / (n - 1) : 0;

    var points = data.map(function(d, i) {
      var x = padL + i * step;
      var y = padT + chartH - (d.total / maxVal) * chartH;
      return {x: x, y: y, total: d.total, period: d.period};
    });

    // Build polygon points for filled area
    var polyPts = points.map(function(p) { return p.x + ',' + p.y; }).join(' ');
    polyPts += ' ' + points[points.length - 1].x + ',' + (padT + chartH);
    polyPts += ' ' + points[0].x + ',' + (padT + chartH);

    var linePts = points.map(function(p) { return p.x + ',' + p.y; }).join(' ');

    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">';

    // Max value label
    svg += '<text x="' + padL + '" y="' + (padT - 8) + '" fill="#525252" font-size="11" font-family="JetBrains Mono,monospace">' + maxVal + '</text>';

    // Baseline
    svg += '<line x1="' + padL + '" y1="' + (padT + chartH) + '" x2="' + (padL + chartW) + '" y2="' + (padT + chartH) + '" stroke="#1a1a1a" stroke-width="1"/>';

    // Filled area
    svg += '<polygon points="' + polyPts + '" fill="rgba(245,158,11,0.15)"/>';

    // Line
    svg += '<polyline points="' + linePts + '" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>';

    // Data points and x-axis labels
    var labelStep = n <= 12 ? 1 : Math.ceil(n / 12);
    for (var i = 0; i < points.length; i++) {
      var p = points[i];
      // Dot
      svg += '<circle cx="' + p.x + '" cy="' + p.y + '" r="3" fill="#0a0a0a" stroke="#f59e0b" stroke-width="1.5" opacity="0.5">';
      svg += '<title>' + esc(p.period) + ': ' + p.total + '</title>';
      svg += '</circle>';
      // Hover dot (larger invisible target)
      svg += '<circle cx="' + p.x + '" cy="' + p.y + '" r="10" fill="transparent" style="cursor:pointer;">';
      svg += '<title>' + esc(p.period) + ': ' + p.total + '</title>';
      svg += '</circle>';
      // X-axis label
      if (i % labelStep === 0) {
        svg += '<text x="' + p.x + '" y="' + (padT + chartH + 18) + '" fill="#404040" font-size="10" font-family="JetBrains Mono,monospace" text-anchor="middle">' + esc(p.period) + '</text>';
      }
    }

    svg += '</svg>';
    container.innerHTML = svg;
  }

  window.openSubscriberCharts = async function() {
    $('subscriberModal').classList.add('show');
    $('chartWeekly').innerHTML = '<span style="color:#404040;font-size:13px;">Loading...</span>';
    $('chartMonthly').innerHTML = '<span style="color:#404040;font-size:13px;">Loading...</span>';
    try {
      var data = await fetchJson('/api/dashboard/subscribers/growth');
      if (!data) {
        $('chartWeekly').innerHTML = '<span style="color:#404040;font-size:13px;">Failed to load data</span>';
        $('chartMonthly').innerHTML = '<span style="color:#404040;font-size:13px;">Failed to load data</span>';
        return;
      }
      renderChart('chartWeekly', data.weekly, 'Weekly');
      renderChart('chartMonthly', data.monthly, 'Monthly');
    } catch(e) {
      $('chartWeekly').innerHTML = '<span style="color:#404040;font-size:13px;">Error loading charts</span>';
      $('chartMonthly').innerHTML = '';
    }
  };

  window.closeSubscriberModal = function(e) {
    if (e && e.target !== $('subscriberModal')) return;
    $('subscriberModal').classList.remove('show');
  };

  // Initial load
  loadAll();

  // Auto-refresh every 60s
  setInterval(loadAll, 60000);
})();
</script>
{% endif %}

</body>
</html>
